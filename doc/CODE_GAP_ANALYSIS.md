# üîç CODE GAP ANALYSIS

**Purpose:** So s√°nh code t·ª´ prompt v·ªõi project hi·ªán t·∫°i ƒë·ªÉ x√°c ƒë·ªãnh ƒëi·ªÅu c·∫ßn implement

---

## ‚ùå MISSING SERVICES (Not in Project)

### 1. **RedisService** üî¥ CRITICAL
**Location:** `src/common/services/redis.service.ts`  
**Status:** ‚ùå NOT FOUND in project  
**From Prompt:** Complete implementation v·ªõi:
- Connection pooling (ioredis)
- Health check (ping)
- Lua script support (scriptLoad, evalsha)
- Distributed lock (acquireLock, releaseLock)
- JSON helpers (setJSON, getJSON)
- Key prefix support

**Current State:**
```typescript
// Project ch·ªâ c√≥ TokenBucketService nh∆∞ng kh√¥ng c√≥ RedisService c∆° b·∫£n
// TokenBucketService inject RedisService (MISSING DEPENDENCY)
```

**Action:** üî¥ MUST CREATE t·ª´ code prompt

---

### 2. **RbacService** üî¥ CRITICAL
**Location:** `src/modules/rbac/rbac.service.ts`  
**Status:** ‚ùå NOT FOUND (only RolesService, PermissionsService exist)  
**From Prompt:** Core RBAC logic:
- `expandUserPermissions(userId, scopeKey)` - Get all permissions with cache
- `checkPermissions(userId, needed[], resource?)` - Check multi-permission
- `applyOwnershipBoost()` - Owner gets auto `manage` permission
- `applyAcl()` - Apply DENY overrides from ResourceACL
- `match()` - Wildcard matching: `user:*`, `*:read`, `manage:*`

**Current State:**
```typescript
// rbac.module.ts
providers: [RolesService, PermissionsService] // ‚¨ÖÔ∏è Missing RbacService
```

**Action:** üî¥ MUST CREATE - This is THE core permission engine

---

### 3. **RbacCacheService** üî¥ CRITICAL
**Location:** `src/modules/rbac/rbac-cache.service.ts`  
**Status:** ‚ùå NOT FOUND  
**From Prompt:** Cache layer cho RBAC:
- User version tracking (`getVersion()`, `bumpUser()`)
- Role version tracking (`getRoleVersion()`, `bumpRole()`)
- Stamp-based cache keys: `user:${userId}:${scope}:${stamp}`
- Dual storage: Redis (production) + in-memory (fallback)

**Why Critical:**
- Without cache, every permission check hits DB (N queries per request)
- With cache: 1 cache hit vs 10+ DB queries
- Performance impact: 10x slower without cache

**Action:** üî¥ MUST CREATE

---

### 4. **RbacAdminService** üü° IMPORTANT
**Location:** `src/modules/rbac/rbac-admin.service.ts`  
**Status:** ‚ùå NOT FOUND  
**From Prompt:** Admin operations:
- `addRoleToUser()`, `removeRoleFromUser()`
- `addPermissionToRole()`, `removePermissionFromRole()`
- `grantAcl()`, `revokeAcl()`
- Auto cache invalidation after mutations

**Current State:**
```typescript
// RolesController c√≥ methods nh∆∞ng kh√¥ng c√≥ dedicated service
// Logic scattered trong controller (bad practice)
```

**Action:** üü° SHOULD CREATE cho clean architecture

---

### 5. **TokenBucketService** üü° PARTIAL EXISTS
**Location:** `src/core/rate-limit/token-bucket.service.ts`  
**Status:** ‚ö†Ô∏è EXISTS but may need updates  
**From Prompt:** Lua script-based rate limiting

**Need to Verify:**
- [ ] Lua script loaded correctly
- [ ] Integrates v·ªõi RedisService
- [ ] Handles Redis unavailable (fallback)
- [ ] Returns correct decision structure

---

### 6. **TokenStateService** üü° IMPORTANT
**Location:** `src/modules/auth/token-state.service.ts`  
**Status:** ‚ùå NOT FOUND  
**From Prompt:** Advanced token management:
- Access version (invalidate all tokens of user)
- Session version (invalidate per session)
- JTI denylist (revoke single token)
- User lock (temporarily block user)

**Current State:**
```typescript
// AuthService c√≥ basic JWT logic
// Missing: version tracking, denylist, lock
```

**Action:** üü° ADD for production security

---

### 7. **DeviceFingerprintService** üü° IMPORTANT
**Location:** `src/common/services/device-fingerprint.service.ts`  
**Status:** ‚ùå NOT FOUND  
**From Prompt:**
- Cookie-based deviceId (UUID)
- HMAC fingerprint: UA + platform + lang + IP/24
- `getOrSetDeviceId()`, `calcSignature()`, `verifySignature()`

**Action:** üü° ADD for device-based security

---

### 8. **DeviceApprovalService** üü¢ NICE TO HAVE
**Location:** `src/modules/auth/device-approval.service.ts`  
**Status:** ‚ùå NOT FOUND  
**From Prompt:**
- Issue approval token when new device detected
- Send magic link via SendGrid
- `approve()` - verify + update session.approved = true

**Action:** üü¢ ADD later for advanced security

---

### 9. **CacheService** üü¢ NICE TO HAVE
**Location:** `src/common/services/cache.service.ts`  
**Status:** ‚ùå NOT FOUND  
**From Prompt:** Multi-layer cache (L1: memory, L2: Redis)

**Action:** üü¢ ADD for performance boost (optional)

---

## ‚ùå MISSING GUARDS

### 1. **PermissionsGuard** üî¥ CRITICAL
**Location:** `src/modules/rbac/guards/permissions.guard.ts`  
**Status:** ‚ùå NOT FOUND  
**From Prompt:**
```typescript
@Injectable()
export class PermissionsGuard implements CanActivate {
  // Read @RequirePermissions() metadata
  // Call RbacService.checkPermissions()
  // Support mode: 'all' | 'any'
  // Extract resourceId from params/query/body
}
```

**Current State:**
```typescript
// Project c√≥ JwtAuthGuard, CustomThrottlerGuard
// Missing: PermissionsGuard (RBAC kh√¥ng work!)
```

**Action:** üî¥ MUST CREATE - Guards are entry point

---

### 2. **RoleGuard** üü° IMPORTANT
**Location:** `src/modules/rbac/guards/role.guard.ts`  
**Status:** ‚ùå NOT FOUND  
**From Prompt:**
```typescript
// Check @RequireRole() v√† @RequireAnyRole()
// Query UserRole table
```

**Action:** üü° SHOULD CREATE

---

### 3. **RateLimitGuard** üü° IMPORTANT
**Location:** `src/common/guards/rate-limit.guard.ts`  
**Status:** ‚ùå NOT FOUND (c√≥ CustomThrottlerGuard kh√°c)  
**From Prompt:**
- Read `@RateLimit()` decorator
- Call `TokenBucketService.consume()`
- Set headers: `RateLimit-Limit`, `RateLimit-Remaining`, `Retry-After`

**Current State:**
```typescript
// C√≥ CustomThrottlerGuard (NestJS throttler module)
// Missing: Custom token bucket rate limit guard
```

**Action:** üü° ADD n·∫øu c·∫ßn granular control

---

## ‚ùå MISSING MIDDLEWARES

### Status Summary
| Middleware | Status | Priority |
|-----------|--------|----------|
| RequestIdMiddleware | ‚úÖ EXISTS | - |
| LoggingMiddleware | ‚ùå NOT FOUND | üü° |
| DeviceFingerprintMiddleware | ‚ùå NOT FOUND | üü° |
| RequestContextMiddleware | ‚ùå NOT FOUND | üü° |
| AnonIdMiddleware | ‚ùå NOT FOUND | üü¢ |
| XssMiddleware | ‚ùå NOT FOUND | üü† |
| CsrfMiddleware | ‚ùå NOT FOUND | üü† |

**All middlewares have complete code in prompt - just need to create files**

---

## ‚ùå MISSING DECORATORS

### 1. **Permission Decorators** üî¥ CRITICAL
```typescript
// src/modules/rbac/decorators/permissions.decorator.ts
@RequirePermissions(...perms)      // ‚ùå NOT FOUND
@RequireAnyPermissions(...perms)   // ‚ùå NOT FOUND
@Resource(type, idSelector)        // ‚ùå NOT FOUND
```

**Current State:**
```typescript
// Project ch·ªâ c√≥ @Public(), @CurrentUser()
// Missing: RBAC decorators
```

---

### 2. **Role Decorators** üü° IMPORTANT
```typescript
// src/modules/rbac/decorators/role.decorator.ts
@RequireRole(roleName)       // ‚ùå NOT FOUND
@RequireAnyRole(...roles)    // ‚ùå NOT FOUND
```

---

### 3. **Rate Limit Decorator** üü° IMPORTANT
```typescript
// src/common/decorators/rate-limit.decorator.ts
@RateLimit({ capacity, refillTokens, refillIntervalMs, keyBy })
```

**Status:** ‚ùå Code c√≥ trong prompt, ch∆∞a trong project

---

### 4. **Validation Decorators** üü¢ NICE TO HAVE
```typescript
// src/common/validators/
@IsStrongPassword()    // ‚ùå NOT FOUND
@XssSanitize()         // ‚ùå NOT FOUND
```

---

## ‚ùå MISSING FILTERS

### **GlobalExceptionFilter** üî¥ IMPORTANT
**Location:** `src/common/filters/global-exception.filter.ts`  
**Status:** ‚ö†Ô∏è Project c√≥ nhi·ªÅu filters (AllExceptionsFilter, HttpExceptionFilter, PrismaClientExceptionFilter)  
**From Prompt:** Unified error handling:
- Map all exceptions ‚Üí structured ErrorResponse
- Log v·ªõi appropriate level
- Capture to Sentry (5xx only)
- Redact sensitive data

**Current Issue:**
```typescript
// main.ts - TOO MANY FILTERS
app.useGlobalFilters(
  new PrismaClientExceptionFilter(),
  new TooManyRequestsFilter(),
  new HttpExceptionFilter(),
  new AllExceptionsFilter(), // ‚¨ÖÔ∏è Should be ONE unified filter
);
```

**Action:** üî¥ REFACTOR - Replace v·ªõi GlobalExceptionFilter t·ª´ prompt

---

## ‚ùå MISSING ERROR CLASSES

### **AppException Hierarchy** üî¥ IMPORTANT
**Location:** `src/common/errors/app.exception.ts`  
**Status:** ‚ùå NOT FOUND  
**From Prompt:**
```typescript
export class AppException extends HttpException {
  constructor(public readonly problem: ProblemDetail) {}
}

export const to400 = (detail, fieldErrors?) => new AppException({...});
export const to401 = (detail) => new AppException({...});
export const to403 = (detail) => new AppException({...});
export const to404 = (detail) => new AppException({...});
export const to409 = (detail) => new AppException({...});
export const to429 = (decision) => new AppException({...});
```

**Current State:**
```typescript
// Project throw generic exceptions
throw new BadRequestException('Invalid input');
// Should be:
throw to400('Invalid email format', { email: 'Must be valid email' });
```

**Action:** üî¥ CREATE - Standardize error responses

---

## ‚ùå MISSING UTILITIES

### 1. **Token Utilities** üü° IMPORTANT
```typescript
// src/modules/auth/refresh-token.util.ts
splitRefreshToken()      // ‚ùå NOT FOUND
buildRefreshToken()      // ‚ùå NOT FOUND
parseDurationToSec()     // ‚ùå NOT FOUND
```

### 2. **Crypto Utilities** üü° IMPORTANT
```typescript
// src/modules/auth/crypto.util.ts
hashPassword()           // ‚ö†Ô∏è May exist in AuthService
verifyPassword()         // ‚ö†Ô∏è May exist in AuthService
hashRefreshPart()        // ‚ùå NOT FOUND
verifyRefreshPart()      // ‚ùå NOT FOUND
```

### 3. **Permission Utilities** üü° IMPORTANT
```typescript
// src/modules/rbac/perms.ts
normSub(), normAct()     // ‚ùå NOT FOUND
permKey()                // ‚ùå NOT FOUND
asDbSubject()            // ‚ùå NOT FOUND
asDbAction()             // ‚ùå NOT FOUND
```

---

## ‚ö†Ô∏è INCOMPLETE IMPLEMENTATIONS

### 1. **BookingsService** ‚ö†Ô∏è PARTIAL
**Issue:** Enum usage fixed, nh∆∞ng thi·∫øu methods:
- ‚ùå `expireHolds()` - auto-expire PENDING bookings
- ‚ùå State machine validation could be stronger

### 2. **OutboxEventService** ‚ö†Ô∏è PARTIAL
**Check:**
- [ ] C√≥ batch processing kh√¥ng?
- [ ] C√≥ retry logic kh√¥ng?
- [ ] C√≥ dead letter queue kh√¥ng?

### 3. **AuthService** ‚ö†Ô∏è PARTIAL
**Missing:**
- ‚ùå Device fingerprint check trong `refreshTokens()`
- ‚ùå Session version check
- ‚ùå Access version check
- ‚ùå JTI denylist check

---

## üîß CONFIGURATION GAPS

### Missing Config Files
```
‚ùå src/config/csrf.config.ts
‚ùå src/config/rate-limit.config.ts
‚ùå src/config/auth.config.ts (cookie options, etc.)
```

### Missing Environment Variables
```env
# Missing from .env.example:
CSRF_SECRET=
DEVICE_APPROVAL_TTL_SEC=900
FP_SECRET=
DEVICE_COOKIE_NAME=dvc
REDIS_PREFIX=booking:
BCRYPT_ROUNDS=12
API_ORIGIN=http://localhost:3000
```

---

## üìä PRIORITY MATRIX

### üî¥ P0 - MUST IMPLEMENT NOW (2-3 days)
1. **RedisService** - Foundation for everything
2. **RbacService** - Core permission engine
3. **RbacCacheService** - Performance critical
4. **PermissionsGuard** - Guards don't work without this
5. **GlobalExceptionFilter** - Error handling mess

### üü° P1 - SHOULD IMPLEMENT SOON (1-2 days)
6. **RbacAdminService** - Clean admin operations
7. **RoleGuard** - Role-based restrictions
8. **TokenStateService** - Advanced token security
9. **DeviceFingerprintService** - Security layer
10. **Middlewares** (Logging, XSS, CSRF, RequestContext)

### üü¢ P2 - NICE TO HAVE (Optional)
11. **DeviceApprovalService** - Advanced device approval
12. **CacheService** - Multi-layer caching
13. **Custom validators** (@IsStrongPassword, @XssSanitize)
14. **Utilities** (token, crypto, permission helpers)

---

## üéØ RECOMMENDED ACTION PLAN

### Week 1: Critical Path
```
Day 1-2: RedisService + RbacService + RbacCacheService
Day 3:   PermissionsGuard + RoleGuard + Decorators
Day 4:   RbacAdminService + Update controllers
Day 5:   GlobalExceptionFilter + AppException + Test
```

### Week 2: Security & Polish
```
Day 1:   TokenStateService + DeviceFingerprintService
Day 2:   Middlewares (Logging, XSS, CSRF)
Day 3:   RateLimitGuard + Monitoring
Day 4:   Database indexes + Query optimization
Day 5:   Load testing + Bug fixes
```

---

## ‚úÖ VALIDATION CHECKLIST

### Before Marking Complete
- [ ] Server starts without errors
- [ ] All guards registered in AppModule
- [ ] RBAC flow tested: seed permissions ‚Üí assign role ‚Üí check permission ‚Üí 200/403
- [ ] Cache working: Redis connected, permissions cached
- [ ] Rate limiting working: burst ‚Üí 429
- [ ] Error responses structured: code + message + meta
- [ ] Logs structured: JSON with requestId, userId
- [ ] Security middlewares active: XSS blocked, CSRF required
- [ ] Health check passes: /health returns 200
- [ ] Unit tests pass: coverage > 80%

---

## üí° KEY INSIGHTS

### Why So Much Missing?
Code t·ª´ prompt l√† **complete enterprise solution** v·ªõi:
- Advanced RBAC v·ªõi caching + versioning
- Device fingerprinting + approval flow
- Token bucket rate limiting v·ªõi Lua scripts
- Multi-layer error handling
- Comprehensive middleware stack

Project hi·ªán t·∫°i c√≥ **solid foundation** nh∆∞ng thi·∫øu:
- Core RBAC engine (only has tables, not logic)
- Redis integration (mentioned but not implemented)
- Advanced auth features (device approval, session management)
- Production-grade error handling

### Recommended Approach
1. **Don't rush** - Implement P0 items first, test thoroughly
2. **Incremental** - Add one service at a time, validate
3. **Test-driven** - Write tests as you go
4. **Document** - Update README with new features

---

**Next Step:** Start v·ªõi `RedisService` + `RbacService` - everything else builds on these üöÄ
